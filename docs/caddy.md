# Caddy

Check the [Caddyfile](../roles/caddy/templates/Caddyfile.j2).

Caddy acts as a reverse proxy to my homelab setup. There are some strategies to issue certificates. Currently, I'm using self-signed certificates from Caddy's CA. In this case every browser/OS will need to install root certificates generated by Caddy to guarantee a trusted SSL connection.

I'm also using Let's Encrypt certificates via challenges as well. It is possible to use your own domain to make DNS-01 challenges possible. Caddy has plugins that automate this for some DNS providers, such as Cloudflare. I also settled with Duck DNS, which is free and supported by Caddy as well.

```bash
# Check installed plugins
/usr/bin/caddy list-modules | grep dns
```

Some services, such as Portainer, use self-signed certs that cannot be easily verified, so a certain Caddy option (tls_insecure_skip_verify) is needed. It is not the ideal solution, but as these services run on localhost this is reasonable and safe for internal LAN use.

Each domain requires two DNS challenges. This happens because wildcard certs don’t cover the apex/root domain. Therefore, Caddy will request wildcard + apex certificates when needed.

## Cloudflare DNS

Just create a wildcard record pointing to your local IP. The Cloudflare Proxy option must be disabled as well. 

## Duck DNS

Duck DNS is a free DNS provider, basically you can claim a subdomain from .duckdns.org and point it wherever you like, like a local IP from my Raspberry. I've seen some videos with it working just fine and decided to try, but as a free service there are some headaches.

![DNS replication](images/caddy/dns%20replication.png)

Some of my subdomains simply do not work. I think it's because the challenge is not being replicated by Duck DNS to the authoritative servers. Take a look at the following log:

```json
Aug 16 13:30:11 raspberrypi caddy[1068]: {"level":"info","ts":1755365411.5826886,"msg":"trying to solve challenge","identifier":"portainer.glomyer.duckdns.org","challenge_type":"dns-01","ca":"https://acme-v02.api.letsencrypt.org/directory"}
Aug 16 13:30:44 raspberrypi caddy[1068]: {"level":"error","ts":1755365444.2546632,"logger":"tls.obtain","msg":"could not get certificate from issuer","identifier":"portainer.glomyer.duckdns.org","issuer":"acme-v02.api.letsencrypt.org-directory","error":"[portainer.glomyer.duckdns.org] solving challenges: waiting for solver certmagic.solverWrapper to be ready: checking DNS propagation of \"_acme-challenge.portainer.glomyer.duckdns.org.\" (relative=_acme-challenge.portainer.glomyer zone=duckdns.org. resolvers=[181.213.132.4:53 181.213.132.5:53 [2804:14d:1:0:181:213:132:4]:53 [2804:14d:1:0:181:213:132:5]:53]): querying authoritative nameservers: dial tcp 15.223.106.16:53: i/o timeout (order=https://acme-v02.api.letsencrypt.org/acme/order/2589567966/418552947227) (ca=https://acme-v02.api.letsencrypt.org/directory)"}
```
Update: I gave it some time (talking about weeks) and now it is working fine. But it is still a free service, so it might not be that much reliable at all times. It will remain mainly as a fallback option from now on.


# How are certificates validated 

Just a little guide for quick reference.

- **Caddy** is the client: it requests, renews, and installs the certificate.
- **Let’s Encrypt** is the certificate authority: it issues the certs.
- **Cloudflare/DuckDNS** provide DNS APIs: they help Caddy prove domain ownership.


## HTTP-01 Challenge

How it works:

1. The CA (e.g., Let’s Encrypt) tells you: “Please place this special file with this token at http://yourdomain.com/.well-known/acme-challenge/...”.
2. The CA then makes an HTTP request to that exact URL.
3. If it finds the expected token, it knows that the server at yourdomain.com is under your control.
4. Certificate is issued.

Requirements:

- Your domain must resolve to a public IP.
- Port 80 (HTTP) must be open and reachable from the internet.


## DNS-01 Challenge

How it works:

1. The CA says: “Please create a TXT record in your DNS: _acme-challenge.yourdomain.com with this token.”
2. The CA queries your domain’s authoritative DNS server for that TXT record.
3. If the record matches, it proves you control the domain.
4. Certificate is issued.

Requirements:

- You must be able to create/edit DNS records for your domain.
- Usually done via your DNS provider’s API (Caddy, Certbot, etc. use plugins like dns.duckdns, dns.cloudflare, etc. to automate this).

Pros:

- Doesn’t require your server to be exposed on port 80 or 443.
- Works with domains that are behind NAT, VPN, firewalls, or reverse proxies.
- Lets you issue wildcard certificates (e.g., *.example.com), which HTTP-01 cannot do.

Cons:

- Slightly more complex: needs DNS provider integration or manual TXT record creation.


# Useful links

- https://github.com/caddyserver/caddy
- https://caddyserver.com/docs/
- https://dash.cloudflare.com/
- https://www.duckdns.org/
- https://github.com/DoTheEvo/selfhosted-apps-docker/tree/master/caddy_v2
