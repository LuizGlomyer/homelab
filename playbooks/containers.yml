- name: Deploy Portainer
  hosts: servers
  become: true

  tasks:
    - name: Create Portainer volume
      community.docker.docker_volume:
        name: portainer_data

    - name: Run Portainer container
      community.docker.docker_container:
        name: portainer
        image: portainer/portainer-ce:latest
        state: started
        restart_policy: always
        container_default_behavior: compatibility
        ports:
          - "8000:8000" # Edge Agent
          - "9443:9443" # Web UI
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock
          - portainer_data:/data


- name: Deploy Uptime Kuma
  hosts: servers
  become: true
  vars:
    uptime_kuma_volume: uptime-kuma

  tasks:
    - name: Create Uptime Kuma volume
      community.docker.docker_volume:
        name: "{{ uptime_kuma_volume }}"

    - name: Run Uptime Kuma container
      community.docker.docker_container:
        name: uptime-kuma
        image: louislam/uptime-kuma:1
        state: started
        restart_policy: always
        ports:
          - "3001:3001"
        volumes:
          - "{{ uptime_kuma_volume }}:/app/data"
        container_default_behavior: compatibility


- name: Deploy Glances
  hosts: servers
  become: true

  tasks:
    - name: Run Glances container
      community.docker.docker_container:
        name: glances
        image: nicolargo/glances:latest-full
        state: started
        restart_policy: always
        command: glances -w
        ports:
          - "61208:61208"
        volumes:
          - /var/run/docker.sock:/var/run/docker.sock:ro
        pid_mode: host
        container_default_behavior: compatibility


- name: Deploy Dashy
  hosts: servers
  become: true

  tasks:
    - name: Ensure config folder exists
      ansible.builtin.file:
        path: /opt/dashy
        state: directory
        mode: '0755'

    - name: Copy Dashy config file to the server
      ansible.builtin.copy:
        src: ./dashy_conf.yml
        dest: /opt/dashy/conf.yml
        owner: root
        group: root
        mode: '0755'

    - name: Copy background image to the server
      ansible.builtin.copy:
        src: ./bg.jpg
        dest: /opt/dashy/bg.jpg
        owner: root
        group: root
        mode: '0755'

    - name: Run Dashy container
      community.docker.docker_container:
        name: dashy
        image: lissy93/dashy:latest
        state: started
        restart_policy: always
        volumes:
          - /opt/dashy/conf.yml:/app/user-data/conf.yml
          - /opt/dashy/bg.jpg:/app/public/bg.jpg
        ports:
          - 9080:8080
        env:
          NODE_ENV: production
        container_default_behavior: compatibility
        healthcheck:
          test: ['CMD', 'node', '/app/services/healthcheck']
          interval: 1m30s
          timeout: 10s
          retries: 3
          start_period: 40s
