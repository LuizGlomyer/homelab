{
  email {{ dns_email }}
}

# --- Reusable TLS blocks ---
(cloudflare-cert) {
  tls {
    dns cloudflare {{ cloudflare_token }}
  }
}

#(duckdns-cert) {
#  tls {
#    dns duckdns {{ duckdns_token }}
#  }
#}

(internal-cert) {
  tls internal
}

# --- Local HTTP ---
localhost, raspberrypi.local {
  root * /srv/public
  file_server
}

# --- Public root landing pages ---
cert.glomyer.dev {
    import cloudflare-cert
    root * /srv/public
    file_server
}

# --- Raspberry Pi Services (looped) ---
{% for svc in caddy_services_raspberry %}
{{ svc.name }}.edge.glomyer.dev {
  import cloudflare-cert

  {% if svc.tls_insecure_skip_verify | default(false) %}
  reverse_proxy https://localhost:{{ svc.port }} {
    transport http {
      tls_insecure_skip_verify
    }
  }
  {% else %}
  reverse_proxy localhost:{{ svc.port }}
  {% endif %}
}


### Internal certificate example
#{{ svc.name }}.lan {
#  import internal-cert
#  {% if svc.tls_insecure_skip_verify | default(false) %}
#  reverse_proxy https://localhost:{{ svc.port }} {
#    transport http {
#      tls_insecure_skip_verify
#    }
#  }
#  {% else %}
#  reverse_proxy localhost:{{ svc.port }}
#  {% endif %}
#}

{% endfor %}


# --- VM Services (looped) ---
{% for svc in caddy_services_vm %}
{{ svc.name }}.glomyer.dev {
  import cloudflare-cert

  {% if svc.tls_insecure_skip_verify | default(false) %}
  reverse_proxy https://192.168.0.200:{{ svc.port }} {
    transport http {
      tls_insecure_skip_verify
    }
  }
  {% else %}
  reverse_proxy 192.168.0.200:{{ svc.port }}
  {% endif %}
}

{% endfor %}
