- name: Create caddy group
  ansible.builtin.group:
    name: "{{ caddy_group }}"
    system: true

- name: Create caddy user with proper home
  ansible.builtin.user:
    name: "{{ caddy_user }}"
    system: true
    group: "{{ caddy_group }}"
    create_home: true
    home: /var/lib/caddy
    shell: /usr/sbin/nologin
    comment: "Caddy web server"

- name: Download xcaddy archive
  ansible.builtin.get_url:
    url: "{{ xcaddy_download_url }}"
    dest: /tmp/xcaddy.tar.gz
    mode: '0644'
  register: xcaddy_download

- name: Extract xcaddy
  ansible.builtin.unarchive:
    src: /tmp/xcaddy.tar.gz
    dest: /tmp/
    remote_src: true
  args:
    creates: /tmp/xcaddy

- name: Build Caddy with DNS plugins
  ansible.builtin.command: >
    /tmp/xcaddy build
    --with github.com/caddy-dns/cloudflare
    --with github.com/caddy-dns/duckdns
    --output /usr/bin/caddy
  args:
    chdir: /tmp
    creates: /usr/bin/caddy
  environment:
    PATH: "/usr/local/go/bin:{{ ansible_facts['env']['PATH'] }}"

- name: Ensure Caddy directories exist
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ caddy_user }}"
    group: "{{ caddy_group }}"
    mode: "0750"
  loop:
    - /var/lib/caddy
    - /etc/caddy/mtls

- name: Ensure Caddy directories exist with correct ownership
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ caddy_user }}"
    group: "{{ caddy_group }}"
    mode: "0750"
    recurse: true
  loop:
    - /var/lib/caddy
    - /etc/caddy/mtls

- name: Create Caddy config directory
  ansible.builtin.file:
    path: /etc/caddy
    state: directory
    mode: '0755'

- name: Upload Caddyfile
  ansible.builtin.template:
    src: "{{ caddyfile }}"
    dest: /etc/caddy/Caddyfile
    owner: root
    group: root
    mode: '0644'
  
- name: Validate Caddy configuration
  ansible.builtin.command: caddy validate --config /etc/caddy/Caddyfile
  register: caddy_validate
  failed_when: caddy_validate.rc != 0
  changed_when: false

- name: Upload systemd service file
  ansible.builtin.copy:
    src: caddy.service
    dest: /etc/systemd/system/caddy.service
    owner: root
    group: root
    mode: '0644'

- name: Ensure Caddy is started so it generates the root cert
  ansible.builtin.service:
    name: caddy
    state: started
    enabled: true

- name: Check if Caddy root certificate exists
  ansible.builtin.stat:
    path: /var/lib/caddy/.local/share/caddy/pki/authorities/local/root.crt
  register: caddy_cert

- name: Ensure /usr/local/share/ca-certificates exists
  ansible.builtin.file:
    path: /usr/local/share/ca-certificates
    state: directory
    mode: '0755'

- name: Copy Caddy root CA certificate to system trusted store
  ansible.builtin.copy:
    src: /var/lib/caddy/.local/share/caddy/pki/authorities/local/root.crt
    dest: /usr/local/share/ca-certificates/Caddy_Local.crt
    owner: root
    group: root
    mode: '0644'
    remote_src: true

- name: Ensure public folder exists
  ansible.builtin.file:
    path: /srv/public
    state: directory
    mode: '0755'

- name: Copy Caddy root CA certificate to public folder
  ansible.builtin.copy:
    src: /var/lib/caddy/.local/share/caddy/pki/authorities/local/root.crt
    dest: /srv/public/root.crt
    mode: '0644'
    remote_src: true

- name: Update trusted certificates
  ansible.builtin.command: update-ca-certificates
  changed_when: true

- name: Reload Caddy service
  ansible.builtin.systemd:
    name: caddy
    state: reloaded
    daemon_reload: true
